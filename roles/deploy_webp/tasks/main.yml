---

- name: Install a list of packages
  yum:
     name:
        - gcc
        - make
        - automake
        - libjpeg-devel
        - libpng-devel
        - libtiff-devel
     state: latest

- name: Unarchive Source Code
  unarchive:
     src: https://storage.googleapis.com/downloads.webmproject.org/releases/webp/libwebp-{{ webp_version }}.tar.gz
     dest: /opt/
     owner: root
     group: root
     remote_src: yes

- name: Build WebP with Magic
  shell: "{{ item }}"
  args:
    chdir:   "{{ webp_dir }}{{ webp_version }}"
  loop:
    - ./configure

- name: Install the WebP
  community.general.make:
    chdir: "{{ webp_dir }}{{ webp_version }}"
    target: install

- name: Make directory for crontab
  file:
    owner: bitrix
    group: bitrix
    path: '{{ www_dir }}/cron'
    mode: 0755
    state: directory

- name: Generate my img2webp
  template: src=img2webp.j2  dest={{ www_dir }}/cron/img2webp.php  owner=bitrix group=bitrix mode=0644

- name: Generate my Webp NGINX Config
  template: src=webp.j2  dest={{ nginx_conf_dir }}/webp.conf  owner=bitrix group=bitrix mode=0644

- name: Generate Bitrix General Config
  template: src=bitrix_general.j2  dest={{ nginx_conf_dir }}/bitrix_general.conf  owner=bitrix group=bitrix mode=0644
  notify: restart nginx

- name: Creates a cron file under /etc/cron.d
  ansible.builtin.cron:
    name: webp
    minute: "50"
    hour: "16"
    user: bitrix
    job: "{{ php_dir }} {{ www_dir }}/cron/img2webp.php --q=80 --dir={{ www_dir }}"
    cron_file: ansible_webp
